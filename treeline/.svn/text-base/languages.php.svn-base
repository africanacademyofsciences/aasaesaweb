<?

	include($_SERVER['DOCUMENT_ROOT'] . "/treeline/includes/treeline.init.php");

	$action = read($_REQUEST,'action','');
	if (!$action) header("Location: /treeline/");
	$guid = read($_REQUEST,'guid','');
		
	$message = read($_REQUEST,'message','');
	$feedback = read($_REQUEST,'feedback','');

	$title = read($_POST,'title','');

	$phrase = read($_POST,'phrase',false);
	$translang = read($_POST,'translang',false);

	$query = "select encoding from languages where abbr='".$_SESSION['treeline_user_language']."'";
	$encoding=$db->get_var($query);
	if (!$encoding) $encoding="utf-8";
	
	$transphrase = read($_POST,'transphrase','');
	//print "trans ($transphrase) to ($encoding) <br>";
	$transphrase = htmlentities($transphrase, ENT_QUOTES, $encoding);

	
	if ($_SERVER['REQUEST_METHOD'] == 'POST') {
	
		//// ADD a new language to this site...
		if ($action == 'create') {

			$newLanguage=$_POST['language'];
			// Add all required pages - maybe dump this out to a function somewhere in sites?
			if ($newLanguage) {
				$site->setLanguage($newLanguage);
				$site->setTagline("Welcome to the $newLanguage site");
				$newVersion=$site->saveVersion($site->properties['microsite']);
				if ($newVersion) {
					if ($site->addPages($newVersion, $site->properties['site_title'], $site->properties['description'], $site->properties['keywords'])) {
						$feedback="success";
						$message[]="New language version[<strong>".$newLanguage."</strong>] created successfully";
					}
					else {
						$message[]="Failed to add pages to your new version.";
						$site->deleteVersion($newVersion);
					}
				}
				else $message[]="Failed to create new language version";
			}
			else $message[]="No language selected";

		}
		else if ($action == 'delete') {

			$site->deleteVersion($_POST['msv']);
			$message[]="Microsite version has been deleted";
			$feedback="success";
			$_POST['msv']=0;
			$action="remove";
		}
		else if ($action=="switch") {
			$msv=$_POST['msv'];
			if ($msv>0) {
				$query="select l.title, l.abbr, l.encoding from languages l left join sites_versions sv on l.abbr = sv.language where sv.msv=$msv";
				$row=$db->get_row($query);
				//print "$query<br>";
				$_SESSION['treeline_user_site_id']=$msv;
				$_SESSION['treeline_user_language']=$row->abbr;
				$_SESSION['treeline_user_encoding']=$row->encoding;
				$_SESSION['treeline_user_language_title']=$row->title;
				$_SESSION['treeline_preview']=$msv;
				header("Location: /treeline/");
			}
		}
		else if($action=='translations'){
			if( $transphrase ){
				//print "got transphrase($transphrase)<br>";
				$message[]=(addTranslation($phrase, $transphrase, $siteID, $_SESSION['treeline_user_language'])==-1?"Could not save translation":"Your translation has been saved");
			}
		}				
		else if($action=='translate_all'){
			$success=$i=0;
			foreach($_POST as $k=>$v) { 
				if (substr($k, 0, strlen("transphrase_id_"))=="transphrase_id_") {
					$id=substr($k, strlen("transphrase_id_"));
					//print "addTranslation($v, ".$_POST['transphrase_'.$id].", $siteID, ".$_SESSION['treeline_user_language'].")<br>";
					switch (addTranslation($v, $_POST['transphrase_'.$id], $siteID, $_SESSION['treeline_user_language'])) {
						case 1: $success++; $i++; break;
						case -1: $i++; break;
					}
				}
			}
			if ($i) $message[]="Saved $success of $i translations";
			if ($success<$i) $message[]=($i-$success)." translation(s) failed to save";
		}
		else if($action=='systranslations'){

			$success=$i=0;
			foreach($_POST as $k=>$v) { 
				if (substr($k, 0, strlen("transphrase_id_"))=="transphrase_id_") {
					$id=substr($k, strlen("transphrase_id_"));
					print "addSysTranslation($v, ".$_POST['transphrase_'.$id].", ".$_POST['syslang'].")<br>";
					switch (addSysTranslation($v, $_POST['transphrase_'.$id], $_POST['syslang'])) {
						case 1: $success++; $i++; break;
						case -1: $i++; break;
					}
				}
			}
			if ($i) $message[]="Saved $success of $i translations";
			if ($success<$i) $message[]=($i-$success)." translation(s) failed to save";
		}

	}


	$css = array('forms','tables'); // all CSS needed by this page
	$extraCSS = '

span#engphrase {
		padding-left:120px;
		font-family:Arial, Helvetica;
		font-size:80%;
	}

input#transphrase {
	width:300px;
}

fieldset {
	border:1px solid #ccc;
	width:450px;
	margin:20px 0;
}
	fieldset legend {
		font-family:Arial, Helvetica;
		font-size:90%;
	}
	
	
div.field {
	float: left;
	clear: left;
}

fieldset.translate_all {
	width:500px;
}
	fieldset.translate_all label {
		width:200px;
	}
	
';

	// Page title	
	$pageTitleH2 = ($action) ? 'Languages : '.ucwords($action) : 'Languages';
	$pageTitle =  $pageTitleH2;
	$pageClass = 'language';

	include($_SERVER['DOCUMENT_ROOT'].'/treeline/includes/templates/header.inc.php');



function addTranslation($id, $translation, $msv, $lang) {
	global $db;

	//print "addT($id, $translation, $msv, $lang)<br>";
	if ($translation) {
		// Get language encoding
		//$coded_translation=htmlentities(mysql_real_escape_string($translation), ENT_QUOTES, $encoding);
		$translation = mysql_real_escape_string($translation);
		$query = "REPLACE INTO labels_translations (label_id,msv,longname) VALUES ('$id', $msv, '$translation')";
		//print "$query<br>";
		if( $db->query( $query ) ){
			$message[] = "Translation saved.";
			
			// Check if we already have a default translation for this term?
			$query="select count(*) from labels_default where label_id=$id AND lang='$lang'";
			if ($db->get_var($query)==0) {
				$query="INSERT INTO labels_default (label_id, lang, longname) values ($id, '$lang', '$translation')";
				//print "$query<br>";
				$db->query($query);
			}
			return 1;	
		}
	}
	else {
		if ($db->get_var("select count(*) from labels_translations where msv=$msv and label_id=$id")>0) {
			$query="delete from labels_translations where msv=$msv and label_id=$id";
			$db->query($query);
		}
		return 0;
	}
	return -1;
}	


function addSysTranslation($id, $translation, $lang) {
	global $db;
	//	print "addSysTranslation($id, $translation, $lang)<br>";
	if ($translation) {
		// Get language encoding
		$query = "select encoding from languages where abbr='$lang'";
		// print "$query<br>";
		if ($encoding=$db->get_var($query)) {
			$coded_translation=htmlentities(mysql_real_escape_string($translation), ENT_QUOTES, $encoding);
			//$translation = mysql_real_escape_string($translation);
			$query="REPLACE INTO labels_default (label_id, lang, longname) values ($id, '$lang', '$coded_translation')";
			//print "$query<br>";
			$db->query($query);
			return 1;
		}
	}
	return -1;
}	

?>


<div id="primarycontent">
<div id="primary_inner">

<?=drawFeedback($feedback,$message)?>	

<? 
if ($action == 'create') { 
	$page_html = '
	<p class="instructions">To add another language to your site, please select it from the menu below.</p>
    <p>This process creates a homepage and functional pages such as news and sitemap and allows you to make sections and pages in your chosen language.</p>
    <form id="treeline" action="'.$_SERVER['PHP_SELF'].'" method="post">
    <input type="hidden" name="action" value="'.$action.'" />
    <fieldset>
        <div class="field" style="padding-top:10px;">
            <label for="lang">Select language:</label>
            '.$page->drawSelectLanguages('language', '', $page->getCurrentLanguageVersions()).'
        </div>	
        <fieldset class="buttons">
            <label for="submit" style="visibility:hidden">Submit:</label>
            <button class="submit" value="submit">Submit</button>
        </fieldset>
    </fieldset>
    </form>
	';
	echo treelineBox($page_html, "Add another language", "blue");
}
else if ($action == 'delete' || $action=="remove") {

	if(!$message || $feedback=="success"){
		if (!$_POST['msv']) { 

			$exclude=array($site->id, $_SESSION['treeline_user_default_site_id']);
			$lang_list=$page->drawAvailableLanguages('msv', $exclude); 

			$page_title = 'Delete a language version';
			$page_html = '
			<p>To delete a language version of this microsite, please select it from the list below below:</p>
            <form id="treeline" action="'.$_SERVER['PHP_SELF'].($DEBUG?'?debug':'').'" method="post">
            <input type="hidden" name="action" value="'.$action.'" />
            <fieldset>
                <div class="field" style="padding-top:10px;">
                    <label for="lang" style="padding-bottom:20px;">Select language:</label>
                    '.($lang_list?$lang_list:'<p style="float:left;width: 310px;">No language versions available to delete. <strong>Note:</strong> You cannot delete the version of a site you are currently editing.</p>').'
                </div>	
				';
			if ($lang_list) $page_html.='
                <div class="field">
                    <label for="submit" style="visibility:hidden">Submit:</label>
                    <input type="submit" class="submit" value="Delete" />
                </div>
				';
			$page_html.='
            </fieldset>
            </form>
			';
		} 
		else {
			$language_title=$page->getLanguageTitle('', $_POST['msv']);
			$page_title = 'Delete <?=$language_title?> language version';
            $page_html = '
            <p>You are about to delete a version of your site.<br />This will remove and sections and pages from this microsite 
            published in <strong><?=$language_title?></strong></p>
            <p><strong><em>Are you sure?</em></strong></p>
            
            <form id="treeline" action="'.$_SERVER['PHP_SELF'].($DEBUG?'?debug':'').'" method="post">
            <input type="hidden" name="action" value="delete" />
            <input type="hidden" name="msv" value="'.$_POST['msv'].'" />
            <fieldset>
                <div class="field">
                    <label for="submit" style="visibility:hidden">Submit:</label>
                    <input type="submit" class="submit" value="Delete" />
                </div>
            </fieldset>
           	</form>
			';
	 	} 
		echo treelineBox($page_html, $page_title, "blue");
 	} 
	else {
		?> 
		<p>Please go back and try again.</p>
		<? 
	} 

} 

else if ($action=="switch") { 

	$exclude=array($site->id);
	$lang_list = $page->drawAvailableLanguages('msv', $exclude);

    $page_html = '
	<p>To modify a different language version of this microsite, please select it from the list below below:</p>
	<form id="treeline" action="'.$_SERVER['PHP_SELF'].'" method="post">
	<input type="hidden" name="action" value="'.$action.'" />
	<fieldset>
		<div class="field" style="padding-top:10px;">
			<label for="lang">Select language:</label>
			'.($lang_list?$lang_list:'<p style="float:left;width: 310px;">No languages available to switch to</p>').'
		</div>	
		';
	if ($lang_list) $page_html.='
		<div class="field">
			<label for="submit" style="visibility:hidden">Submit:</label>
			<input class="submit" type="submit" value="Switch" />
		</div>
		';
	$page_html.='		
	</fieldset>
	</form>
	';
	echo treelineBox($page_html, "Switch to editing a different language version", "blue");
	
} 

else if ($action == 'translations') { 
	?>

	<h3>Amend <?=ucfirst(strtolower($_SESSION['treeline_user_language_title']))?> Translations</h3>
	<hr />
	<p>In this section you can alter the translations of words & phrases used around the site.
	The English versions will always stay the same.</p>
	<p>You can use the form below to select specific translations or <a href="/treeline/languages/?action=translate_all">translate all labels at once</a>.</p>
    <form id="treeline" action="<?=$_SERVER['PHP_SELF']?><?php if ($DEBUG) echo '?debug'?>" method="post">
	<input type="hidden" name="action" value="<?=$action?>" />
	<input type="hidden" name="phrase" value="<?=$phrase?>" />
	<fieldset>
		<legend>Select phrase</legend>
		<div class="field">
			<label for="phrase">Default phrase</label>
			<select name="phrase" id="phrase" onchange="document.location='/treeline/languages/?action=<?=$action?>&amp;phrase='+this.value;">
			<?
            $query = "select id, longname, comment from labels l where system=0 order by l.longname";
			//print "phrase(".$_REQUEST['phrase'].") $query<br>";
            if( $results = $db->get_results( $query ) ){
                foreach( $results as $item ){ 
                	if ($item->id==$_REQUEST['phrase']) {
						$comment=$item->comment;
						$label_text=$item->longname;
					}
					?>
                    <option style="width:350px;" value="<?= $item->id ?>"<? if($_REQUEST['phrase']==$item->id){ echo ' selected="selected"'; } ?>><?= $item->longname ?></option>
                	<? 
				}
            }
            ?>
			</select>
		</div>
        <?=(($comment)?'<div class="field"><label for="usagetext">Label usage</label><p style="float: left;">'.$comment.'</p></div>':"")?>
        <?=(($label_text)?'<div class="field"><label for="labeltext">Label text</label><p style="float: left;">'.$label_text.'</p></div>':"")?>
		
        <?php if ($_REQUEST['phrase']) { ?>
			
			<? 
            $query = "SELECT lt.longname FROM labels_translations lt WHERE lt.msv=".$siteID." and lt.label_id=".$_REQUEST['phrase'];
            $thisphrase = $db->get_row($query);
			//print "got trans (".$thisphrase->longname.") decoded(".$thisphrase->longname.") ".utf8_decode($thisphrase->longname)."<br>";
            ?>
            
            <div class="field">
            	<label for="transphrase"><?=ucfirst(strtolower($_SESSION['treeline_user_language_title']))?> phrase</label>
                <input type="text" name="transphrase" id="transphrase" value="<?=html_entity_decode($thisphrase->longname)?>" />
            </div>
        
            <fieldset class="buttons">
                <button class="submit" value="update">Update</button>
            </fieldset>
        <?php } ?>
	</fieldset>
	</form>

	<? 
} 

else if ($action == 'translate_all') { 
	?>

	<h3>Amend <?=ucfirst(strtolower($_SESSION['treeline_user_language_title']))?> Translations</h3>
	<hr />
	<p>You can use the form below to change all the label translations in one go.</p>
    <form id="treeline" action="<?=$_SERVER['PHP_SELF']?><?php if ($DEBUG) echo '?debug'?>" method="post">
	<input type="hidden" name="action" value="<?=$action?>" />
	<input type="hidden" name="phrase" value="<?=$phrase?>" />
	<fieldset class="translate_all">
		<legend>Enter translations</legend>
        <div class="field">
            <? 
			$l=$page->getTranslations($_SESSION['treeline_user_site_id'], $_SESSION['treeline_user_language'], 0);
            foreach ($l as $label) {
				$i++;
				//print_r($label);
				?>
				<label for="transphrase_<?=$i?>"><?=$label['eng']?></label>
				<input type="hidden" name="transphrase_id_<?=$i?>" value="<?=$label['id']?>" />
				<input type="text" name="transphrase_<?=$i?>" id="transphrase_<?=$i?>" value="<?=(($_POST['transphrase_'.$i])?$_POST['transphrase_'.$i]:$label['txt'])?>" /> 
				<?php
            }
            ?>
        </div>
    
        <fieldset class="buttons">
            <button class="submit" value="update">Update</button>
        </fieldset>
	</fieldset>
	</form>

	<? 
	
} 

else if ($action == 'systranslations') { 

	$syslang=read($_REQUEST, 'syslang', 'en');
	?>

    <form style="background:none;border:none;" method="GET" id="f_setsyslang" action="<?=$_SERVER['PHP_SELF']?><?php if ($DEBUG) echo '?debug'?>" method="post">
	<input type="hidden" name="action" value="<?=$action?>" />
	<h3>Master <select style="margin-bottom:3px;" onchange="document.getElementById('f_setsyslang').submit.click();" name="syslang"><?=$page->drawSelectLanguages("syslang", $syslang, array(), false)?></select> Translations</h3>
    <input name="submit" type="submit" class="hide" />
    </form>
    
	<hr />
	<p>You can use the form below to change all the label translations in one go.</p>
    
    <form id="treeline" action="<?=$_SERVER['PHP_SELF']?><?php if ($DEBUG) echo '?debug'?>" method="post">
	<input type="hidden" name="action" value="<?=$action?>" />
	<input type="hidden" name="syslang" value="<?=$syslang?>" />
	<fieldset class="translate_all">
		<legend>Enter translations</legend>
        <div class="field">
            <? 
			$l=$page->getTranslations($_SESSION['treeline_user_site_id'], $syslang);
            foreach ($l as $label) {
				$i++;
				//print_r($label);
				?>
				<label for="transphrase_<?=$i?>"><?=$label['eng']?></label>
				<input type="hidden" name="transphrase_id_<?=$i?>" value="<?=$label['id']?>" />
				<input type="text" name="transphrase_<?=$i?>" id="transphrase_<?=$i?>" value="<?=(($_POST['transphrase_'.$i])?$_POST['transphrase_'.$i]:$label['txt'])?>" /> 
				<?php
            }
            ?>
        </div>
    
        <fieldset class="buttons">
            <button class="submit" value="update">Update</button>
        </fieldset>
	</fieldset>
	</form>


	<? 
} 

?>

</div>
</div>
<?php include($_SERVER['DOCUMENT_ROOT']."/treeline/includes/templates/footer.inc.php"); ?>