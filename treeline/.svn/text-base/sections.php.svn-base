<?

	include($_SERVER['DOCUMENT_ROOT'] . "/treeline/includes/treeline.init.php");
	
	// Make sure no direct/unauthorised access to this page
	if ($_SESSION['treeline_user_group']!="Superuser") redirect("/treeline/");
	
	$action = read($_REQUEST,'action','');
	if (!$action) header("Location: /treeline/");
	$guid = read($_REQUEST,'guid','');
		
	$message = read($_REQUEST,'message','');
	$feedback = read($_REQUEST,'feedback','');

	$title = read($_POST,'title','');
	
	$nextsteps='';
	
	if ($_SERVER['REQUEST_METHOD'] == 'POST') {
		
		$section_template = read($_POST,'section_template',11);
	
		if ($action == 'create') {
			
			if(!$title){
				$feedback = 'error';
				$message = 'Your section needs to have a title!';
			}
			else{
				//// The name it's likelt to find matching is not this page, then generate a name...
				$name = $treeline->generateName($site->id, $title);
				if ($site->id==1 && $site->checkSiteName($name)) {
					$feedback = "error";
					$message[] = "A microsite exists with that name.";
					$message[] = "You cannot create pages on this site that have the same name as any microsites.";
				}
				else if(!$name){
					$feedback = 'error';
					$message[] = "Your new section <strong>$title</strong> could not be updated.";
					$message[] = "Another section exists with this title!";
				}
				else {
					if($treeline->saveSection('',$name,$title,$section_template)) {
						// What do we want to do next ?		
						if ($_SESSION['treeline_user_group']!="Author") {
							$nextsteps.='<li><a href="/treeline/sections/?action=edit">Edit site sections</a></li>';
							$nextsteps.='<li><a href="/treeline/sections/?action=create">Create another section</a></li>';
						}
						$nextsteps.='<li><a href="/treeline/pages/?action=create">Create a new web page</a></li>';
						$nextsteps.='<li><a href="/treeline/pages/?action=edit">Manage web pages</a></li>';
						$action="";
					}
					else{
						$feedback = 'error';
						$message = 'Your section could not be added to the system';
					}
				}
			}
		
		}
		// EDIT A SECTION
		elseif ($action == 'edit') {
		
			$sections = array();
			foreach($_POST as $key => $value){

				if(($key != 'Save changes &raquo;') && ($key != 'action') && ($key != 'guid') ){
					$tmpKey = substr($key,0,strrpos($key,'_'));
					if( substr_count($tmpKey,'template')>0 ){
						$tmpKey = 'template';
					}
					$guid = substr($key,strrpos($key,'_')+1);
					$sections[$guid][$tmpKey] = $value;
				}


			}
			
			//echo '<pre>'. print_r($sections,true) .'</pre>';
			foreach($sections as $guid => $section){
				
				if($guid != $treeline->chkName($site->id,$section['title']) ){
					//// The name it's likely to find matching is not this page, then generate a name...
					$name = $treeline->generateName($site->id,$section['title']);
					
					if($name){
						$feedback = 'success';
						$message = 'Your changes have been saved';
					}else{
						$feedback = 'error';
						$message[] = 'Section changed to <strong>'. $value .'</strong> could not be updated.<br />
										Another section already exists with this title';
					}
					
				}else{
					$name='';
				}
				
				if( $treeline->saveSection($guid,$section['name'],$section['title'],$section['template'],$section['order'])  ){
					$feedback = 'success';
					$message = 'Your changes were saved';
				}
				else{
					$feedback = 'error';
					$message = 'No changes were made';
				}
			}
			
		} // END OF EDIT SECTION
		
		// Delete a section
		else if($action == 'delete'){
			if($guid){
				$treeline->deleteSection($guid);
				if ($_SESSION['treeline_user_group']!="Author") {
					$nextsteps.='<li><a href="/treeline/sections/?action=delete">Delete another section</a></li>';
					$nextsteps.='<li><a href="/treeline/sections/?action=create">Create a new section</a></li>';
					$nextsteps.='<li><a href="/treeline/sections/?action=edit">Edit site sections</a></li>';
				}
				$nextsteps.='<li><a href="/treeline/pages/?action=edit">Manage web pages</a></li>';
				$action="";
			}
			else{
				$feedback = 'error';
				$message = 'Could not delete this section';
			}
		}
			
	}
	
	// PAGE specific HTML settings
	
	$css = array('forms','tables'); // all CSS needed by this page
	$extraCSS = '

form fieldset input {
	width: 220px;
}

/* sections specific */
input.section-name {
	width: 100px !important;
}

select {
	width: 122px !important;
}
hr{ 
	clear: both; 
	border-width: 0 0 1px;
}
	
label.sort_order, label.template{
	clear: none;
	display: inline;
	margin-left: .5em;
	width: 6em;
}
	
label.template{
	width: 4em;
}

input.sort_order{
	clear: none;
	display: inline;
	width: 2em;
}

'; // extra on page CSS
	
	$js = array(); // all external JavaScript needed by this page
	$extraJS = ''; // extra on page JavaScript
	
	// Page title	
	$pageTitleH2 = ($action) ? 'Sections : '.ucwords($action) : 'Sections';
	$pageTitle = ($action) ? 'Sections : '.ucwords($action) : 'Sections';
	
	$pageClass = 'edit-structure';
	if ($action=="create") $pageClass="create-content";
	
	include($_SERVER['DOCUMENT_ROOT'].'/treeline/includes/templates/header.inc.php');
		
?>
<div id="primarycontent">
<div id="primary_inner">
<?php
	echo drawFeedback($feedback,$message);

	if ($nextsteps) echo treelineList($nextsteps, "Next steps", "blue");

	if ($action == 'create') {
		$page_html = '
        <form id="treeline" action="/treeline/sections/?action='.$action.($DEBUG?"&amp;debug":"").'" method="post">
            <fieldset>
                <input type="hidden" name="action" value="'.$action.'" />
                <input type="hidden" name="guid" value="'.$guid.'" />
                <label for="title">Section title:</label>
                <input class="section-name" type="text" name="title" id="title" value="'.$title.'" />
                <label for="section_template" class="template">Type</label>
                '.$treeline->drawSectionTemplates($section_template,"","section_template").'
                <fieldset class="buttons">
                	<input type="submit" class="submit" value="Save" />
                </fieldset>
            </fieldset>
        </form>	
		';
		$page_title="To add a top-level section, please enter the title in the field below";
		echo treelineBox($page_html, $page_title, "blue");
	}
	elseif ($action == 'edit') {
		$page_html = '
		<form id="treeline" action="/treeline/sections/?action='.$action.($DEBUG?'&amp;debug':"").'" method="post">
		<fieldset>
			<input type="hidden" name="action" value="'.$action.'" />
			<input type="hidden" name="guid" value="'.$guid.'" />
			'.$treeline->drawEditableSections().'
			<p class="instructions"><strong>Please note: </strong>Sections cannot be renamed as this would create broken links on your site, in search engines and on the websites that link to you.</p>
			<fieldset class="buttons">
				<input type="submit" class="submit" value="Save changes" />
			</fieldset>
		</fieldset>
		</form>
		';
		echo treelineBox($page_html, "Reorder sections here", "blue");
}
elseif ($action == 'delete' && !$guid) { 
	$page_html = '<p><em>Only sections that contain no pages can be deleted.</em></p>';
	$page_html .= $treeline->drawDeleteableSections($site->id);
	echo treelineBox($page_html, "To delete a top-level section, please select from the list below", "blue");
}
else if ($action == "delete" && $guid) { 
	$page_html = '
	<form id="treeline" action="/treeline/sections/?action='.$action.($DEBUG?'&amp;debug':"").'" method="post">
	<fieldset>
		<input type="hidden" name="action" value="'.$action.'" />
		<input type="hidden" name="guid" value="'.$guid.'" />
		<p class="instructions">Are you sure you want to permanently delete this section?<br />
		<strong>This may affect the appearance of your website</strong>.</p>
		<input type="hidden" name="guid" value="'.$guid.'" />
		<input type="hidden" name="title" value="'.$treeline->getSectionByGUID($guid).'" />
			<input type="submit" class="submit" value="Yes, delete it!" />
		</fieldset>
	</fieldset>
  	</form>
  	';
	echo treelineBox($page_html, "Delete : ".$treeline->getSectionByGUID($guid), "blue");
}
?>
</div>
</div>
<?php include($_SERVER['DOCUMENT_ROOT']."/treeline/includes/templates/footer.inc.php"); ?>