<?php

// A gallery is a page...
include($_SERVER['DOCUMENT_ROOT']."/treeline/includes/page.class.php");
include($_SERVER['DOCUMENT_ROOT']."/treeline/includes/gallery.class.php");

include($_SERVER['DOCUMENT_ROOT']."/treeline/includes/treeline.init.php");


/* page_guid is used throughout gallery code to make things more clear than just guid,
but there are times when we need to accept guid when other parts of Treeline send us here. */

$_REQUEST['page_guid'] = (isset($_REQUEST['guid'])) ? $_REQUEST['guid'] : $_REQUEST['page_guid'];

if (!$_REQUEST['page_guid']) {
	header('location:/treeline/');
}

print "running galleries.php<br>"; exit();


$gallery_page = new Gallery;						// Make a new Gallery page
$gallery_page->loadByGUID($_REQUEST['page_guid']);	// Load the page
$gallery_page->setRevision(1);					// We are working with the non-live gallery

/* We need an entry in the content table so that the gallery page
appears in the publishable pages list. */
if ($db->get_var("SELECT COUNT(id) FROM content WHERE parent = '".$gallery_page->getGUID()."'"))
{
	// We are editing this gallery, so presume changes were made; now make it publishable:
	$gallery_page->save();
	$db->query("UPDATE content SET revision_id = 1 WHERE parent = '".$gallery_page->getGUID()."'");
}
else	// No content entry, so make one
{
	$db->query
	("
		INSERT INTO content (parent, content, placeholder, revision_id) 
		VALUES ('".$gallery_page->getGUID()."', 'This content is for the gallery ".$gallery_page->title."', 'content', 1)
	");
}





/* Store the page guid that we are editing in the session
so that the image picker knows where to add the image */
$_SESSION['gallery_page_guid'] = $gallery_page->getGUID();








// ########## VIEW AN IMAGE ##########
if ($_GET['action'] == 'view' && $_GET['image_guid'])
{
	$image = $gallery_page->getImage($_GET['image_guid']);
	$filename = $image['filenames'][5]; // Select size
	header("location:/silo/images/$filename");
	exit;
}



// ########## EDIT AN IMAGE ##########
if ($_POST['action'] == 'edit' && $_POST['image_guid'])
{
	// Fields to change
	$details = array(
		'description' => $_POST['description']
	);
	if ($gallery_page->updateImage($_POST['image_guid'], $details)) {
		$feedback = 'success';
		$message = 'Image details updated.';
	} else {
		$message = 'No changes were made.';
	}
}



// ########## DELETE AN IMAGE ##########
elseif ($_POST['action'] == 'delete' && $_POST['image_guid'])
{
	if ($_POST['confirm'] == 'Yes' && $gallery_page->deleteImage($_POST['image_guid'])) {
		$feedback = 'success';
		$message = 'Image deleted from gallery.';
	} else {
		$message = 'No changes were made.';
	}
}



// ########## ADD AN EXISTING IMAGE ##########
elseif ($_GET['action'] == 'add_existing' && $_GET['image_guid'])
{
	// Using GET because we are usually sent here via the image picker
	if ($gallery_page->addExistingImage($_GET['image_guid'])) {
		$feedback = 'success';
		$message = 'Image added to gallery.';
	} else {
		$message = 'The image is already in the gallery.';
	}
}



// ########## RE-ORDER IMAGES ##########
elseif ($_POST['action'] == 'order')
{
	// Go through each image's new sort order, and update it
	foreach ($_POST['sort_order'] as $image_guid => $sort_order)
	{	
		// Fields to change
		$details = array(
			'sort_order' => $sort_order
		);
		$gallery_page->updateImage($image_guid, $details);
	}
	/* Because the user can directly change the sort order,
	they might make mistakes, so we have to fix it. */
	$gallery_page->fixSortOrder();
	$feedback = 'success';
	$message = 'Images order saved.';
}


// ########## PUBLISH PAGE AND GALLERY IMAGES ##########
elseif ($_GET['action'] == 'publish' && $_GET['guid'])
{
	$gallery_page->publish();
	
	/* Make the content placeholder unpublishable now we have just published this page,
	this is so the gallery doesn't appear in the publishable pages list, until it is edited again. */
	$db->query("UPDATE content SET revision_id = 0 WHERE parent = '".$gallery_page->getGUID()."'");
	
	redirect('/treeline/?section=publish&'.createFeedbackURL('success','The image gallery has been published.'));
}














// PAGE specific HTML settings
$css = array('forms'); // all CSS needed by this page
$extraCSS = '

div.thumb {
	margin:0 10px 20px 0;
	padding:4px 4px 2px 4px;
	background:#dce1e1;
	float:left;
}
div.thumb:hover {
	background:#c9d1d1
}
div.thumb a.thumb {
	display:block;
	background:#000;
	width:100px;
	height:75px;
	overflow:hidden;
	background-repeat:no-repeat;
	background-position:center;
	border:1px solid #f3f7f7
}
div.thumb a.thumb img {
	display:none;
}
div.thumb a {
	outline:none
}
div.thumb a img {
	border:0 !important
}
div.thumb div {
	text-align:right
}
div.thumb div img {
	margin:5px 3px 0 0
}
div.thumb div input {
	width:20px;
	margin:5px 0 0 3px
}
.mceEditor {
	visibility:hidden
}
#tiny_mce_container {
	height:0
}
';

$js = array(); // all external JavaScript needed by this page
$extraJS = '

function viewImage(filename) {
	var p = window.open(
		filename,
		"TL",
		"toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=1,width=640,height=480"
	);
	p.focus();
}
$(document).ready(function(){
	$("a.thumb").click(function() {
		viewImage($(this).attr("href"));
		return false;
	});
});

'; // extra on page JavaScript

// Page title	
$pageTitleH2 = 'Gallery : Edit';
$pageTitle = 'Gallery : Edit';	
$pageClass = '';

include($_SERVER['DOCUMENT_ROOT'].'/treeline/includes/templates/header.inc.php');	
?>
<div id="primarycontent">
<div id="primary_inner">
<?php
echo drawFeedback($feedback,$message);

print "got action($action)<br>";

if ($_GET['action'] != 'edit' && $_GET['action'] != 'delete')	// Viewing the gallery
{
?>
<p>Currently editing the gallery page <strong>'<?=$gallery_page->title?>'</strong>.</p>
<hr />
<p>Add an image to this gallery: <a href="javascript:tinyMCE.execInstanceCommand('mce_editor_0','mceTreelineImage');">Launch image picker</a>.</p>
<p>Or&nbsp; <a href="../images/?action=create">Upload</a> a new image into Treeline.</p>
<script type="text/javascript" src="/treeline/includes/tiny_mce/tiny_mce.js"></script>
<script type="text/javascript">
  tinyMCE.init({
  mode:"exact",
  elements:"image_to_add",
  theme:"advanced",
  plugins:"treeline_image",
  theme_advanced_buttons1:"image",
  theme_advanced_buttons2:"",
  theme_advanced_buttons3:""
});
</script>
<div id="tiny_mce_container">
  <div id="image_to_add"></div>
</div>
<?php } ?>




<form id="treeline" action="/treeline/galleries/<?php if ($DEBUG) echo '?debug'?>" method="post">
	<fieldset>
	<input type="hidden" name="page_guid" value="<?=$_REQUEST['page_guid']?>" />


		
		
		
		
<?php


// ########## EDIT AN IMAGE'S DETAILS ##########
if ($_GET['action'] == 'edit' && $_GET['image_guid'])
{
	$image = $gallery_page->getImage($_GET['image_guid']);
	$description = htmlentities($image['description']);
	$filename = $image['filenames'][10];	// Select size
	echo <<<EOT
	
<legend>Edit image caption</legend>
<p>
  <label for="description"><strong>Caption:</strong></label><br />
  <textarea name="description" id="description" rows="5" cols="40">$description</textarea>
</p>
<fieldset class="buttons">
  <input type="hidden" name="image_guid" value="{$_GET['image_guid']}" />
  <input type="hidden" name="action" value="edit" />
  <button type="submit" class="submit">Save changes</button>
</fieldset>
<p><img src="/silo/images/$filename" alt="Image" style="margin-top:15px" /></p>
EOT;
}






// ########## PROMPT TO DELETE AN IMAGE ##########
elseif ($_GET['action'] == 'delete' && $_GET['image_guid'])
{
	$image = $gallery_page->getImage($_GET['image_guid']);
	$description = htmlentities($image['description']);
	$filename = $image['filenames'][10];	// Select size
	echo <<<EOT
<legend>Delete image</legend><br />
<p><strong>Are you sure you want to delete this image from the gallery?</strong></p>
<p><img src="/silo/images/$filename" alt="$description" /></p>
<p>$description</p>
<fieldset class="buttons">
  <input type="hidden" name="image_guid" value="{$_GET['image_guid']}" />
  <input type="hidden" name="action" value="delete" />
  <button type="submit" class="submit" name="confirm" value="Yes" style="margin-right:10px">Yes</button>
  <button type="submit" class="submit" name="confirm" value="No">No</button>
</fieldset>
EOT;
}





// ########## VIEW A GALLERY'S IMAGES ##########
else
{	
	echo '<legend>Thumbnails</legend><br />',"\n";
	
	$thumbnails = $gallery_page->getImages(75,100);
	
	if ($thumbnails) {	
		foreach ($thumbnails as $thumb)
		{
			$filename = '/silo/images/'.$thumb->filename;
			$description = htmlentities($thumb->description);
				
			echo <<<EOT
<div class="thumb">
  <a style="background-image:url($filename)" href="?action=view&amp;page_guid={$_REQUEST['page_guid']}&amp;image_guid=$thumb->image_guid" target="_blank" class="thumb" title="$description"><img src="$filename" alt="$description" /></a>
  <div>
    <input type="text" name="sort_order[$thumb->image_guid]" value="$thumb->sort_order" title="Sort order" />
    <a href="?action=edit&amp;page_guid={$_REQUEST['page_guid']}&amp;image_guid=$thumb->image_guid" title="Edit image"><img src="/treeline/img/icons/edit_sm.gif" alt="Edit image" /></a>
    <a href="?action=delete&amp;page_guid={$_REQUEST['page_guid']}&amp;image_guid=$thumb->image_guid" title="Delete image"><img src="/treeline/img/icons/delete_sm.gif" alt="Edit image" /></a>
  </div>
</div>

EOT;
		}
		echo <<<EOT
<fieldset class="buttons" style="padding-left:0">
  <input type="hidden" name="action" value="order" />
  <button type="submit" class="submit">Save order</button>
</fieldset>
EOT;
	} else {
		echo '<p>There are no images in this gallery.</p>';
	}
}



?>


	</fieldset>
</form>
</div>
</div>
<?php
include($_SERVER['DOCUMENT_ROOT']."/treeline/includes/templates/footer.inc.php");
?>
