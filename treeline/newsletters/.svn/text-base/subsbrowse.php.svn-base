<?php

include($_SERVER['DOCUMENT_ROOT']."/treeline/includes/treeline.init.php");
include($_SERVER['DOCUMENT_ROOT']."/treeline/newsletters/includes/newsletter.class.php");

session_start();

function smartTruncate($str, $maxLen){
	if(strlen($str) < $maxLen){
		return($str);
	}else{
		$str = substr($str, 0, $maxLen - 4) . " ...";
		return($str);
	}
}
function htmlShortDate($strDate){
// Formats a date/time string for output to HTML
	if($strDate != "")return("" . date("j M Y", strtotime($strDate)) . "");
	else return("N/A");
}

$action=read($_SERVER['REQUEST_METHOD']=="POST"?$_POST:$_GET, "action", "newsletter");

$showFrom = addslashes($_REQUEST["sf"]);
if(!$showFrom) $showFrom = 0;
$showRows = addslashes($_REQUEST["sr"]);
if(!$showRows) $showRows = 10;

$searchEmail = $_REQUEST["se"];
$searchFullname = $_REQUEST["sfn"];


$orderBy = addslashes($_REQUEST["ob"]); // Column to orderby
$orderDir = strtoupper(addslashes($_REQUEST["od"])); // Direction to orderby - DESC or ASC
if(!$orderBy){
	$orderBy = "date_edited";
	if(!$orderDir){
		$orderDir = "DESC";
	}
}
if($orderDir != "DESC") $orderDir = "ASC";



	if ($action == "unsubcribe") {
	
		$newsletter = new Newsletter();
		$member_id=addslashes($_GET["id"]);
		if ($member_id>0) {
			$newsletter->unsubscribe("", $member_id);
			$action="";
		}
		
	}


$message = read($_REQUEST,'message','');
$feedback = read($_REQUEST,'feedback','error');

	// Error reporting
	// err=1 update ok, err=2 update failed
	$message="";
	if ($_GET['msg']) $message=$_GET['msg'];
	else if ($_GET['err']) {
		switch($_GET['err']) {
			case 1 : $feedback = 'success'; $message="Subscriber updated"; break;
			case 2 : $message="Subscriber update failed"; break;
			case 4 : $message="Subscriber data invalid"; break;
			case 5 : $message="Email address exists already"; break;
			default : $message="Processing error($err)"; break;
		}
	}

	
	// PAGE specific HTML settings
	
	$css = array('forms','tables'); // all CSS needed by this page
	$extraCSS = ''; // extra on page CSS
	
	$js = array(); // all external JavaScript needed by this page
	$extraJS = ''; // extra on page JavaScript
	
	// Page title	
	$pageTitleH2 = 'Browse Newsletter Subscribers';
	$pageTitle = 'Browse Newsletter Subscribers';
	
	$pageClass = 'newsletters';
	
	include($_SERVER['DOCUMENT_ROOT'].'/treeline/includes/templates/header.inc.php');	
?>

<div id="primarycontent">
  <div id="primary_inner">
    <?=drawFeedback($feedback,$message)?>
    <!--<p><a href="/treeline/newsletters/subsedit/?action=create">Add a new subscriber</a></p> Hidden as new subscribers can be added from the front-end.-->
    <?php

	$totalPerPage  = ($_REQUEST['sr']) ? $_REQUEST['sr'] : 10;
			
	$strSQL = "SELECT count(DISTINCT m.member_id) 
		FROM members m
		LEFT JOIN newsletter_user_preferences nup ON m.member_id=nup.member_id
		LEFT JOIN newsletter_preferences np on nup.preference_id=np.preference_id
		WHERE np.deleted=0
		AND site_id = ".$site->id." ";
	if($searchEmail) $strSQL .= "AND m.email LIKE '%" . addslashes($searchEmail) . "%' ";
	if($searchFullname) $strSQL .= "AND concat(m.firstname, ' ', m.surname) LIKE '%" . addslashes($searchFullname) . "%' ";
	$hits = $db->get_var($strSQL);
			
	$currentPage = ($_REQUEST['p']) ? $_REQUEST['p'] : 1;
	$pagination = drawNewPagination($hits, $totalPerPage, $currentPage, "/treeline/newsletters/subsbrowse/?sfn=$searchFullname&amp;se=$searchEmail&amp;ob=$orderBy&amp;od=$orderDir&amp;sr=".$totalPerPage);

	// Fetch old newsletters
	$query = "SELECT m.member_id as id, m.email, concat(m.firstname, ' ', m.surname) as fullname, 
		m.date_edited, date_added
		FROM members m
		LEFT JOIN newsletter_user_preferences nup ON m.member_id=nup.member_id
		LEFT JOIN newsletter_preferences np on nup.preference_id=np.preference_id
		WHERE np.deleted=0
		AND site_id = ".$site->id." ";
	if($searchEmail) $query .= "AND m.email LIKE '%" . addslashes($searchEmail) . "%' ";
	if($searchFullname) $query .= "AND concat(m.firstname, ' ', m.surname) LIKE '%" . addslashes($searchFullname) . "%' ";
	$query .= "GROUP BY id ";
	$query .= 	"ORDER BY $orderBy $orderDir";
	$startLimit = ($currentPage-1)*$totalPerPage; // work out which record to start from in the database	
	$limitQuery = $startLimit.', '.$totalPerPage;
	$query .= " LIMIT ".$limitQuery;
	//print "$query<Br>";
	
	$page_html = '
    <form id="frmShowSubscribers" action="" method="get">
      <fieldset>
      <label for="fullname">Search Full Name</label>
      <input type="text" class="text" name="sfn" id="fullname" maxlength="255" size="30" value="'.htmlspecialchars(stripslashes($searchFullname)).'" /><br />
      <label for="email">Search Email</label>
      <input type="text" class="text" id="email" name="se" maxlength="255" size="30" value="'.htmlspecialchars(stripslashes($searchEmail)).'"/><br />
      <label for="orderby">Order By</label>
      <select name="ob" id="orderby" style="width:140px; margin-right: 12px">
        <option value="date_added"'.($orderBy == "date_added" ? " selected=\"selected\"" : "").'>date</option>
        <option value="email"'.($orderBy == "email" ? " selected=\"selected\"" : "").'>email</option>
        <option value="fullname"'.($orderBy == "fullname" ? " selected=\"selected\"" : "").'>name</option>
      </select> 
      <select name="od" style="width:140px;">
        <option value="ASC"'.($orderDir == "ASC" ? " selected=\"selected\"" : "").'>ascending</option>
        <option value="DESC"'.($orderDir == "DESC" ? " selected=\"selected\"" : "").'>descending</option>
      </select><br />
      <label for="nresults">Show Results</label>
      <select name="sr" id="nresults">
        <!-- <option value="2"'.($showRows == "2" ? " selected=\"selected\"" : "").'>2 per page</option> -->
        <option value="5"'.($showRows == "5" ? " selected=\"selected\"" : "").'>5 per page</option>
        <option value="10"'.($showRows == "10" ? " selected=\"selected\"" : "").'>10 per page</option>
        <option value="20"'.($showRows == "20" ? " selected=\"selected\"" : "").'>20 per page</option>
        <option value="50"'.($showRows == "50" ? " selected=\"selected\"" : "").'>50 per page</option>
      </select><br />
      <fieldset class="buttons">
      	<input type="submit" class="submit" value="Search" />
      </fieldset>
      </fieldset>
    </form>
	';
	echo treelineBox($page_html, "Find subscribers", "blue");
			
	if($db->query($query)){
		$results = $db->get_results(null);
		//$idx = 0;
		?>
    	<table class="treeline">
      	<caption>Subscribers - <?php echo ($hits . " result" . ($hits == 1 ? "" : "s") . " found"); ?></caption>
        <thead>
        <tr>
            <th scope="col">Email</th>
            <th scope="col">Full Name</th>
            <th scope="col">Date</th>
            <th scope="col">Edit</th>
            <th scope="col">Delete</th>
        </tr>
        </thead>
        <tbody>
        <?php

		foreach($results as $result){
			$editlink = "<a href=\"/treeline/newsletters/subsedit/?action=edit&amp;id=" . $result->id . "\" title=\"Edit\">Edit</a>";
			switch ($s->opted_in) {
				// Already unsubscribed
				case 0 : 
					$dellink = '<a href="/treeline/newsletters/subsbrowse/?id='.$result->id.'&amp;action=unsubcribe" title="Unsusbscribe">Unsubscribe</a>';
					break;
				case 1 :
				default :
					$dellink = '<a href="/treeline/newsletters/subsbrowse/?id='.$result->id.'&amp;action=resubcribe" title="Resubscribe">Resubscribe</a>';
					break;
			}

			$date = ($result->date_changed) ? $result->date_changed : $result->date_added;
		?>
        <tr>
          <td><?php echo smartTruncate(stripslashes($result->email), 40); ?></td>
          <td><?php echo smartTruncate(stripslashes($result->fullname), 40); ?></td>
          <td><?php echo getUFDate($date); ?></td>
          <td class="action edit"><?php echo $editlink; ?></td>
          <td class="action delete"><?php echo $dellink; ?></td>
        </tr>
        <?php } ?>

        </tbody>
        </table>
        <?php echo $pagination; ?>

    	<?php
	} 
	else { 
		?>
	    <p class="warn">No subscribers found</p>
      	<?php 
	} 
	?>

</div>
</div>
<?php include($_SERVER['DOCUMENT_ROOT']."/treeline/includes/templates/footer.inc.php"); ?>
